<!DOCTYPE html>
<html>
    <head>
        <style>
        [data-tooltip] {
            position: relative;
            z-index: 2;
            cursor: pointer;
          }
          
          [data-tooltip]:before,
          [data-tooltip]:after {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
          }
          
          [data-tooltip]:before {
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-bottom: 5px;
            margin-left: -80px;
            padding: 7px;
            width: 160px;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
            background-color: #000;
            background-color: hsla(0, 0%, 20%, 0.9);
            color: #fff;
            content: attr(data-tooltip);
            text-align: center;
            font-size: 14px;
            line-height: 1.2;
          }
          
          [data-tooltip]:after {
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            width: 0;
            border-top: 5px solid #000;
            border-top: 5px solid hsla(0, 0%, 20%, 0.9);
            border-right: 5px solid transparent;
            border-left: 5px solid transparent;
            content: " ";
            font-size: 0;
            line-height: 0;
          }
          
          [data-tooltip]:hover:before,
          [data-tooltip]:hover:after {
            visibility: visible;
            opacity: 1;
          }
        </style>
    </head>
    <body>
        <div>
            <input type="file" accept=".sl2">
            <select id="characters" style="display: none;"></select>
        </div>

        <div id="character" style="display: none;">
            <h2 id="name" class="stat" style="margin: 0;"></h2>
            <br/>
            <div style="display: inline-block; vertical-align: top;">
                <div>Level: <span id="runeLevel" class="stat"></span></div>
                <div>Runes: <span id="runes" class="stat"></span></div>
                <div>Rune Memory: <span id="runeMemory" class="stat"></span></div>
                <br/>
                <div>Health: <span id="maxHealth" class="stat"></span></div>
                <div>Mana: <span id="maxMana" class="stat"></span></div>
                <div>Stamina: <span id="maxStamina" class="stat"></span></div>
                <br/>
                <div>Vigor: <span id="vigor" class="stat"></span></div>
                <div>Mind: <span id="mind" class="stat"></span></div>
                <div>Endurance: <span id="endurance" class="stat"></span></div>
                <div>Strength: <span id="strength" class="stat"></span></div>
                <div>Dexterity: <span id="dexterity" class="stat"></span></div>
                <div>Intelligence: <span id="intelligence" class="stat"></span></div>
                <div>Faith: <span id="faith" class="stat"></span></div>
                <div>Arcane: <span id="arcane" class="stat"></span></div>
            </div>
            <div style="display: inline-block; vertical-align: top; margin-left: 20px;">
                <div>Unk1: <span id="unk1" class="stat"></span></div>
                <div>Unk2: <span id="unk2" class="stat"></span></div>
                <div>Unk3: <span id="unk3" class="stat"></span></div>
                <div>Unk4: <span id="unk4" class="stat"></span></div>
                <div>Unk5: <span id="unk5" class="stat"></span></div>
                <div>Unk6: <span id="unk6" class="stat"></span></div>
                <div>Unk7: <span id="unk7" class="stat"></span></div>
            </div>
            <div style="display: inline-block; vertical-align: top; margin-left: 20px;">
                <h3 style="margin: 0;">Equipped Spells</h3>
                <div id="spells"></div>
            </div>
            <br/>
            <div style="display: inline-block; vertical-align: top;">
                <h3 style="margin: 0;">Weapons</h3>
                <div id="weapon" style="display: grid; grid-template-columns: repeat(6, 1fr);"></div>
            </div>
            <div style="display: inline-block; vertical-align: top;">
                <h3 style="margin: 0;">Armor</h3>
                <div id="armor" style="display: grid; grid-template-columns: repeat(6, 1fr);"></div>
            </div>
            <div style="display: inline-block; vertical-align: top;">
                <h3 style="margin: 0;">Ash of War</h3>
                <div id="ash" style="display: grid; grid-template-columns: repeat(6, 1fr);"></div>
            </div>
            <div style="display: inline-block; vertical-align: top;">
                <h3 style="margin: 0;">Talismans</h3>
                <div id="talisman" style="display: grid; grid-template-columns: repeat(6, 1fr);"></div>
            </div>
            <div style="display: inline-block; vertical-align: top;">
                <h3 style="margin: 0;">Goods</h3>
                <div id="goods" style="display: grid; grid-template-columns: repeat(6, 1fr);"></div>
            </div>
            <div style="display: inline-block; vertical-align: top;">
                <h3 style="margin: 0;">Key Items</h3>
                <div id="keyitems" style="display: grid; grid-template-columns: repeat(6, 1fr);"></div>
            </div>
        </div>

        <script type="module">
            import { SaveData } from './src/savedata.js';

            window.savedata = null;

            function renderCharacter() {
                let slot = parseInt(document.querySelector('#characters').value);

                if(slot < 0 || slot > 10)
                    return;

                const blacklist = ['Unarmed', 'Head', 'Body', 'Arms', 'Legs'];
                
                let inventory = savedata.characters[slot].inventory.filter(x => x.name !== undefined && !blacklist.includes(x.name));

                let keyitems = savedata.characters[slot].keyitems.filter(x => x.name !== undefined);

                let sortGoods = (a,b) => {
                    if(a.params.goodsType == b.params.goodsType) {
                        if(a.params.sortGroupId == b.params.sortGroupId)
                            return a.params.sortId - b.params.sortId;
                        return a.params.sortGroupId - b.params.sortGroupId;
                    }
                    return a.params.goodsType - b.params.goodsType;
                }

                let renderItem = (item) => {
                    let i = document.createElement("div");
                    i.style.display = "inline-block";
                    if(item.params.iconId > -1 || item.params.iconIdM > -1  || item.params.iconIdF > -1 ) {
                        let id = item.params.iconId || item.params.iconIdM || item.params.iconIdF;
                        let img = document.createElement('img');
                        img.src = `images/MENU_Knowledge_${String(id).padStart(5, 0)}.png`;
                        img.width = '48';
                        img.height = '48';
                        img.style.backgroundColor = "rgba(50, 50, 50, 1)";
                        img.style.border = "1px solid black";
                        img.style.margin = "1px 1px 0px 0px";
                        img.style.borderRadius = "5px";

                        let itemString = item.name;
                        if(item.level > 0)
                            itemString += ' +' + item.level;
                        if(item.qty > 1)
                            itemString += ' x' + item.qty;

                        i.setAttribute('data-tooltip', itemString);
                        i.appendChild(img);
                    }
                    return i;
                }

                keyitems.sort(sortGoods);

                document.getElementById('keyitems').innerHTML = "";

                keyitems.forEach((item) => document.getElementById('keyitems').appendChild(renderItem(item)))

                let update = (type, title) => {
                    let items = inventory.filter(x => x.type == type);

                    items.sort(sortGoods);

                    document.getElementById(type).innerHTML = "";

                    items.forEach((item) => document.getElementById(type).appendChild(renderItem(item)))
                }

                update('weapon')
                update('armor')
                update('ash')
                update('talisman')
                update('goods')

                document.getElementById('spells').innerHTML = "";

                savedata.characters[slot].spells.forEach((item) => document.getElementById('spells').appendChild(renderItem(item)))

                document.getElementById('character').querySelectorAll('.stat').forEach(el => {
                    if(el.id && savedata.characters[slot][el.id] != undefined) {
                        el.innerHTML = savedata.characters[slot][el.id];
                    }
                })
                document.getElementById('character').style.display = 'block';
            }

            function showFile() {
                let file = document.querySelector('input[type=file]').files[0];
                if(!file)
                    return;
                let reader = new FileReader();
                reader.onload = function (event) {
                    window.savedata = new SaveData(reader.result);
                    console.log(window.savedata);


                    let selectEl = document.querySelector('#characters');
                    while(selectEl.options.length > 0) {                
                        selectEl.remove(0);
                    }

                    for(var i=0; i<savedata.characters.length; i++) {
                        if(savedata.characters[i] !== false && savedata.characters[i].name != "") {
                            let option = document.createElement("option");
                            option.text = savedata.characters[i].name;
                            option.value = i;
                            selectEl.add(option);
                        }
                    }

                    if(selectEl.options.length > 0) {
                        selectEl.style.display = 'inline-block';
                        selectEl.value = 0;
                        renderCharacter();
                    } else {
                        selectEl.style.display = 'none';
                        document.getElementById('character').style.display = 'none';
                    }
                }
                reader.readAsArrayBuffer(file);
            }

            document.querySelector('input').addEventListener('change', showFile);
            document.querySelector('#characters').addEventListener('change', renderCharacter);
        </script>
    </body>
</html>