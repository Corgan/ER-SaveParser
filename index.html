<!DOCTYPE html>
<html>
    <head>
        <style>
    [data-tooltip] {
        position: relative;
        z-index: 2;
        cursor: pointer;
    }
        
    [data-tooltip]:before,
    [data-tooltip]:after {
        visibility: hidden;
        opacity: 0;
        pointer-events: none;
    }
        
    [data-tooltip]:before {
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-bottom: 5px;
        margin-left: -80px;
        padding: 7px;
        width: 160px;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        background-color: #000;
        background-color: hsla(0, 0%, 20%, 0.9);
        color: #fff;
        content: attr(data-tooltip);
        text-align: center;
        font-size: 14px;
        line-height: 1.2;
    }
        
    [data-tooltip]:after {
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        width: 0;
        border-top: 5px solid #000;
        border-top: 5px solid hsla(0, 0%, 20%, 0.9);
        border-right: 5px solid transparent;
        border-left: 5px solid transparent;
        content: " ";
        font-size: 0;
        line-height: 0;
    }
        
    [data-tooltip]:hover:before,
    [data-tooltip]:hover:after {
        visibility: visible;
        opacity: 1;
    }

    #tab-select > span {
        display: inline-block;
        border-radius: 2px;
        background-color: rgba(100, 100, 100, 1);
        font-size: 16px;
        padding: 2px 5px;
        margin: 1px;
        color: white;
    }

    #tab-select > span.active {
        font-weight: bold;
    }

    #tab-content > div:not(.active) {
        display: none;
    }

    #tab-content > div > div {
        width: 493px;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        margin-bottom: 8px;
        margin-top: 3px;
        border-bottom: solid 2px black;
    }
    #tab-content > div > div:last-child {
        border-bottom: none;
    }
          </style>
    </head>
    <body>
        <div>
            <input type="file" accept=".sl2">
            <select id="characters" style="display: none;"></select>
        </div>

        <div id="character" style="display: none;">
            <h2 id="name" class="stat" style="margin: 0;"></h2>
            <br/>
            <div style="display: inline-block; vertical-align: top;">
                <div>Level: <span id="runeLevel" class="stat"></span></div>
                <div>Runes: <span id="runes" class="stat"></span></div>
                <div>Rune Memory: <span id="runeMemory" class="stat"></span></div>
                <br/>
                <div>Health: <span id="maxHealth" class="stat"></span></div>
                <div>Mana: <span id="maxMana" class="stat"></span></div>
                <div>Stamina: <span id="maxStamina" class="stat"></span></div>
                <br/>
                <div>Vigor: <span id="vigor" class="stat"></span></div>
                <div>Mind: <span id="mind" class="stat"></span></div>
                <div>Endurance: <span id="endurance" class="stat"></span></div>
                <div>Strength: <span id="strength" class="stat"></span></div>
                <div>Dexterity: <span id="dexterity" class="stat"></span></div>
                <div>Intelligence: <span id="intelligence" class="stat"></span></div>
                <div>Faith: <span id="faith" class="stat"></span></div>
                <div>Arcane: <span id="arcane" class="stat"></span></div>
            </div>
            <div style="display: inline-block; vertical-align: top; margin-left: 20px;">
                <div>Unk1: <span id="unk1" class="stat"></span></div>
                <div>Unk2: <span id="unk2" class="stat"></span></div>
                <div>Unk3: <span id="unk3" class="stat"></span></div>
                <div>Unk4: <span id="unk4" class="stat"></span></div>
                <div>Unk5: <span id="unk5" class="stat"></span></div>
                <div>Unk6: <span id="unk6" class="stat"></span></div>
                <div>Unk7: <span id="unk7" class="stat"></span></div>
            </div>
            <div style="display: inline-block; vertical-align: top; margin-left: 20px;">
                <h3 style="margin: 0;">Equipped Spells</h3>
                <div id="spells"></div>
            </div>
            <br/>
            <div id="tabs">
                <div id="tab-select"></div>
                <div id="tab-content"></div>
            </div>
        </div>

        <script type="module">
            import { SaveData } from './src/savedata.js';
            import lookup from './src/lookup.js'

            window.lookup = lookup;
            window.savedata = null;

            function renderCharacter() {
                let slot = parseInt(document.querySelector('#characters').value);

                if(slot < 0 || slot > 10)
                    return;

                const blacklist = ['Unarmed', 'Head', 'Body', 'Arms', 'Legs'];
                
                let inventory = savedata.characters[slot].inventory.filter(x => x.name !== undefined && !blacklist.includes(x.name));

                let keyitems = savedata.characters[slot].keyitems.filter(x => x.name !== undefined);

                let sortGroup = (a,b) => { return a.params.sortId - b.params.sortId; }

                let renderItem = (item) => {
                    let i = document.createElement("div");
                    i.style.display = "inline-block";
                    if(item.params.iconId > -1 || item.params.iconIdM > -1  || item.params.iconIdF > -1 ) {
                        let id = item.params.iconId || item.params.iconIdM || item.params.iconIdF;
                        let img = document.createElement('img');
                        img.src = `images/MENU_Knowledge_${String(id).padStart(5, 0)}.png`;
                        img.style.backgroundColor = "rgba(50, 50, 50, 1)";
                        img.style.border = "1px solid black";
                        img.style.margin = "1px 1px 0px 0px";
                        img.style.borderRadius = "5px";

                        let itemString = item.name;
                        if(item.level > 0)
                            itemString += ' +' + item.level;
                        if(item.qty > 1) {
                            let qty = document.createElement("div");
                            qty.style.position = 'absolute';
                            qty.style.bottom = '8px';
                            qty.style.right = '8px';
                            qty.style.color = 'white';
                            qty.appendChild(document.createTextNode(item.qty));
                            i.appendChild(qty);
                        }

                        i.setAttribute('data-tooltip', itemString);
                        i.appendChild(img);
                    }
                    return i;
                }

                let tabs = {};

                tabs.tools = { name: "Tools", data: inventory.filter(item => item.params.goodsType == 0 || item.params.goodsType == 3) };
                tabs.ashes = { name: "Ashes", data: inventory.filter(item => item.params.goodsType == 7 || item.params.goodsType == 8) };
                tabs.crafting = { name: "Crafting Materials", data: inventory.filter(item => item.params.goodsType == 2) };
                tabs.bolstering = { name: "Bolstering Materials", data: inventory.filter(item => item.params.goodsType == 14) };
                tabs.keyitems = { name: "Key Items", data: inventory.filter(item => item.params.goodsType == 10 || item.params.goodsType == 11).concat(keyitems) };
                tabs.sorceries = { name: "Sorceries", data: inventory.filter(item => item.params.goodsType == 5 || item.params.goodsType == 17) };
                tabs.incantations = { name: "Incantations", data: inventory.filter(item => item.params.goodsType == 16 || item.params.goodsType == 18) };
                tabs.ashofwar = { name: "Ashes of War", data: inventory.filter(item => item.type == "ash") };
                tabs.melee = { name: "Melee Armaments", data: inventory.filter(item => [1,3,5,7,9,11,13,14,15,16,17,19,2123,24,25,28,29,31,33,35,37,39,41].includes(item.params.wepType)) };
                tabs.rangedcatalyst = { name: "Ranged Weapons / Catalysts", data: inventory.filter(item => [50,51,53,55,56,57,59,61].includes(item.params.wepType)) };
                tabs.arrowbolts = { name: "Arrows/Bolts", data: inventory.filter(item => [81,83,85,86].includes(item.params.wepType)) };
                tabs.shields = { name: "Shields", data: inventory.filter(item => [65,67,69,87].includes(item.params.wepType)) };
                tabs.head = { name: "Head", data: inventory.filter(item => item.params.protectorCategory == 0) };
                tabs.chest = { name: "Chest", data: inventory.filter(item => item.params.protectorCategory == 1) };
                tabs.arms = { name: "Arms", data: inventory.filter(item => item.params.protectorCategory == 2) };
                tabs.legs = { name: "Legs", data: inventory.filter(item => item.params.protectorCategory == 3) };
                tabs.talismans = { name: "Talismans", data: inventory.filter(item => item.params.accessoryCategory == 0) };
                tabs.info = { name: "Info", data: inventory.filter(item => item.params.goodsType == 12) };

                let update = (type, title) => {
                    let items = inventory.filter(x => x.type == type);

                    items.sort(sortGoods);

                    document.getElementById(type).innerHTML = "";

                    items.forEach((item) => document.getElementById(type).appendChild(renderItem(item)))
                }

                let tabSelect = document.getElementById('tab-select');
                tabSelect.innerHTML = '';
                let tabContent = document.getElementById('tab-content')
                tabContent.innerHTML = '';

                Object.entries(tabs).forEach(([id, tab], i) => {
                    let tabTitle = document.createElement('span');
                    if(i == 0)
                        tabTitle.classList.add('active');
                    tabTitle.appendChild(document.createTextNode(tab.name));
                    tabSelect.appendChild(tabTitle);
                    tabTitle.addEventListener('click', e => {
                        let selectChildren = [...tabSelect.children];
                        let contentChildren = [...tabContent.children];
                        let oldIndex = selectChildren.findIndex(e => e.classList.contains('active'));
                        let newIndex = selectChildren.indexOf(e.target);
                        selectChildren[oldIndex].classList.remove('active');
                        contentChildren[oldIndex].classList.remove('active');
                        selectChildren[newIndex].classList.add('active');
                        contentChildren[newIndex].classList.add('active');
                    })

                    let tabEl = document.createElement('div');
                    if(i == 0)
                        tabEl.classList.add('active');
                    
                    let items = new Set(tab.data.map(item => item.params.sortGroupId));
                    new Array(...items).sort((a,b) => a-b).forEach(groupId => {
                        let group = document.createElement('div');
                        tab.data.filter(item => item.params.sortGroupId == groupId).sort(sortGroup).forEach(item => {
                            group.appendChild(renderItem(item));
                        })
                        tabEl.appendChild(group);
                    })
                    tabContent.appendChild(tabEl);
                });

                /*update('weapon')
                update('armor')
                update('ash')
                update('talisman')
                update('goods')*/

                document.getElementById('spells').innerHTML = "";

                savedata.characters[slot].spells.forEach((item) => document.getElementById('spells').appendChild(renderItem(item)))

                document.getElementById('character').querySelectorAll('.stat').forEach(el => {
                    if(el.id && savedata.characters[slot][el.id] != undefined) {
                        el.innerHTML = savedata.characters[slot][el.id];
                    }
                })
                document.getElementById('character').style.display = 'block';
            }

            function showFile() {
                let file = document.querySelector('input[type=file]').files[0];
                if(!file)
                    return;
                let reader = new FileReader();
                reader.onload = function (event) {
                    window.savedata = new SaveData(reader.result);
                    console.log(window.savedata);


                    let selectEl = document.querySelector('#characters');
                    while(selectEl.options.length > 0) {                
                        selectEl.remove(0);
                    }

                    for(var i=0; i<savedata.characters.length; i++) {
                        if(savedata.characters[i] !== false && savedata.characters[i].name != "") {
                            let option = document.createElement("option");
                            option.text = savedata.characters[i].name;
                            option.value = i;
                            selectEl.add(option);
                        }
                    }

                    if(selectEl.options.length > 0) {
                        selectEl.style.display = 'inline-block';
                        selectEl.value = 0;
                        renderCharacter();
                    } else {
                        selectEl.style.display = 'none';
                        document.getElementById('character').style.display = 'none';
                    }
                }
                reader.readAsArrayBuffer(file);
            }

            document.querySelector('input').addEventListener('change', showFile);
            document.querySelector('#characters').addEventListener('change', renderCharacter);
        </script>
    </body>
</html>